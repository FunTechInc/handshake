{"version":3,"file":"handshake.js","sources":["../src/handshake.ts"],"sourcesContent":["type ReadyEvent = {\n   emit: (key: string, value: any) => void;\n   on: (key: string, callback: (value: any) => void) => void;\n   revert: () => void;\n};\ntype MessageData = { type: string; key?: string; value?: any };\ntype MESSAGE_TYPES = \"handshake\" | \"handshake-reply\" | \"event\";\n\nconst MAX_HANDSHAKE_REQUESTS: number = 50;\nconst HANDSHAKE_REQUESTS_INTERVAL: number = 100;\nconst ALLOWED_MESSAGE_TYPES: MESSAGE_TYPES[] = [\n   \"handshake\",\n   \"handshake-reply\",\n   \"event\",\n];\n\nfunction sanitize(message: MessageEvent, allowedOrigin?: string): boolean {\n   if (allowedOrigin == null) return false;\n   if (message.origin !== allowedOrigin) return false;\n   if (!message.data || typeof message.data !== \"object\") return false;\n   const data = message.data as { type?: MESSAGE_TYPES };\n   if (!data.type) return false;\n   if (!ALLOWED_MESSAGE_TYPES.includes(data.type)) return false;\n   return true;\n}\n\nabstract class BaseChannel {\n   protected _Promise: Promise<this>;\n   protected _PromiseResolver!: (value: this | PromiseLike<this>) => void;\n   protected _PromiseRejecter!: (reason?: any) => void;\n\n   protected _handlers: { [key: string]: Array<(value: any) => void> };\n   protected _targetWindow?: Window | null;\n   protected _targetOrigin?: string;\n\n   protected _bindedOnMessage: (e: MessageEvent) => void;\n\n   constructor(opt: { targetWindow?: Window; targetOrigin?: string } = {}) {\n      this._Promise = new Promise<this>((resolve, reject) => {\n         this._PromiseResolver = resolve;\n         this._PromiseRejecter = reject;\n      });\n      this._handlers = {};\n      this._targetWindow = opt.targetWindow;\n      this._targetOrigin = opt.targetOrigin;\n\n      this._bindedOnMessage = this._onMessage.bind(this);\n      window.addEventListener(\"message\", this._bindedOnMessage);\n   }\n\n   protected _sendMessage(msg: any): void {\n      if (this._targetOrigin == null) return;\n      this._targetWindow?.postMessage(msg, this._targetOrigin);\n   }\n\n   protected _trigger(key: string, value: any): void {\n      if (this._handlers[key]) this._handlers[key].forEach((cb) => cb(value));\n   }\n\n   public ready(callback: (event: ReadyEvent) => void): void {\n      this._Promise.then((instance) => {\n         callback({\n            ...instance,\n            emit: this.emit.bind(this),\n            on: this.on.bind(this),\n            revert: this.revert.bind(this),\n         });\n      });\n   }\n\n   public emit(key: string, value: any): void {\n      this._sendMessage({ type: \"event\", key, value });\n   }\n\n   public on(key: string, callback: (value: any) => void): void {\n      if (!this._handlers[key]) this._handlers[key] = [];\n      this._handlers[key].push(callback);\n   }\n\n   public revert(): void {\n      window.removeEventListener(\"message\", this._bindedOnMessage);\n   }\n\n   protected abstract _onMessage(event: MessageEvent): void;\n   protected _handleOnMessage(\n      e: MessageEvent,\n      type: MESSAGE_TYPES,\n      callback: () => void\n   ) {\n      if (!sanitize(e, this._targetOrigin)) return;\n      const msg = e.data as MessageData;\n      if (msg.type === type) {\n         callback();\n         this._PromiseResolver(this);\n      } else if (msg.type === \"event\" && msg.key != undefined) {\n         this._trigger(msg.key, msg.value);\n      }\n   }\n}\n\nexport class Parent extends BaseChannel {\n   public container: HTMLElement;\n   public iframe: HTMLIFrameElement;\n   protected _handshakeInterval?: number;\n\n   constructor(opt: { container: string; url: string }) {\n      super();\n\n      const container = document.getElementById(opt.container);\n      if (!container) throw new Error(\"Container element not found\");\n      this.container = container;\n      this.iframe = document.createElement(\"iframe\");\n      this.iframe.style.width = \"100%\";\n      this.iframe.style.height = \"100%\";\n      this.iframe.style.position = \"absolute\";\n\n      this.container.appendChild(this.iframe);\n\n      this._targetOrigin = new URL(opt.url).origin;\n\n      this.iframe.addEventListener(\"load\", () => {\n         this._targetWindow = this.iframe.contentWindow;\n         this._startHandshake();\n      });\n      this.iframe.src = opt.url;\n   }\n\n   public revert() {\n      super.revert();\n      this.iframe.parentNode?.removeChild(this.iframe);\n   }\n\n   public ready(\n      callback: (\n         event: {\n            iframe: HTMLIFrameElement;\n            container: HTMLElement;\n         } & ReadyEvent\n      ) => void\n   ): void {\n      super.ready(callback as any);\n   }\n\n   private _startHandshake(): void {\n      let attempt = 0;\n      const handshakeInterval = window.setInterval(() => {\n         attempt++;\n         if (attempt > MAX_HANDSHAKE_REQUESTS) {\n            clearInterval(handshakeInterval);\n            this._PromiseRejecter(new Error(\"Handshake failed\"));\n         } else {\n            this._sendMessage({ type: \"handshake\" });\n         }\n      }, HANDSHAKE_REQUESTS_INTERVAL);\n      this._handshakeInterval = handshakeInterval;\n   }\n\n   protected _onMessage(e: MessageEvent): void {\n      this._handleOnMessage(e, \"handshake-reply\", () =>\n         clearInterval(this._handshakeInterval)\n      );\n   }\n}\n\nexport class Child extends BaseChannel {\n   constructor(opt: { url: string }) {\n      super({\n         targetWindow: window.parent,\n         targetOrigin: new URL(opt.url).origin,\n      });\n   }\n\n   protected _onMessage(e: MessageEvent): void {\n      this._handleOnMessage(e, \"handshake\", () => {\n         this._targetOrigin = e.origin;\n         this._sendMessage({ type: \"handshake-reply\" });\n      });\n   }\n}\n"],"names":["ALLOWED_MESSAGE_TYPES","sanitize","message","allowedOrigin","data","BaseChannel","opt","__publicField","resolve","reject","msg","_a","key","value","cb","callback","instance","e","type","Parent","container","attempt","handshakeInterval","Child"],"mappings":"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"}