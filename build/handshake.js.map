{"version":3,"file":"handshake.js","sources":["../src/handshake.ts"],"sourcesContent":["type Emit = (key: string, value: any) => void;\ntype On = (key: string, callback: (value: any) => void) => void;\ntype ReadyEvent = {\n   emit: Emit;\n   on: On;\n};\ntype MessageData = { type: string; key?: string; value?: any };\ntype MESSAGE_TYPES = \"handshake\" | \"handshake-reply\" | \"event\";\n\nconst MAX_HANDSHAKE_REQUESTS: number = 5;\nconst HANDSHAKE_REQUESTS_INTERVAL: number = 500;\nconst ALLOWED_MESSAGE_TYPES: MESSAGE_TYPES[] = [\n   \"handshake\",\n   \"handshake-reply\",\n   \"event\",\n];\n\nfunction sanitize(message: MessageEvent, allowedOrigin?: string): boolean {\n   if (allowedOrigin == null) return false;\n   if (message.origin !== allowedOrigin) return false;\n   if (!message.data || typeof message.data !== \"object\") return false;\n   const data = message.data as { type?: MESSAGE_TYPES };\n   if (!data.type) return false;\n   if (!ALLOWED_MESSAGE_TYPES.includes(data.type)) return false;\n   return true;\n}\n\nabstract class BaseChannel {\n   protected _Promise: Promise<this>;\n   protected _PromiseResolver!: (value: this | PromiseLike<this>) => void;\n   protected _PromiseRejecter!: (reason?: any) => void;\n\n   protected _handlers: { [key: string]: Array<(value: any) => void> };\n   protected _targetWindow?: Window | null;\n   protected _targetOrigin?: string;\n\n   constructor(opt: { targetWindow?: Window; targetOrigin?: string } = {}) {\n      this._Promise = new Promise<this>((resolve, reject) => {\n         this._PromiseResolver = resolve;\n         this._PromiseRejecter = reject;\n      });\n      this._handlers = {};\n      this._targetWindow = opt.targetWindow;\n      this._targetOrigin = opt.targetOrigin;\n      window.addEventListener(\"message\", this._onMessage.bind(this));\n   }\n\n   protected _sendMessage(msg: any): void {\n      if (this._targetOrigin == null) return;\n      this._targetWindow?.postMessage(msg, this._targetOrigin);\n   }\n\n   protected _trigger(key: string, value: any): void {\n      if (this._handlers[key]) this._handlers[key].forEach((cb) => cb(value));\n   }\n\n   public ready(callback: (event: ReadyEvent) => void): void {\n      this._Promise.then(callback);\n   }\n\n   public emit: Emit = (key, value) =>\n      this._sendMessage({ type: \"event\", key, value });\n\n   public on: On = (key, callback) => {\n      if (!this._handlers[key]) this._handlers[key] = [];\n      this._handlers[key].push(callback);\n   };\n\n   protected abstract _onMessage(event: MessageEvent): void;\n   protected _handleOnMessage(\n      e: MessageEvent,\n      type: MESSAGE_TYPES,\n      callback: () => void\n   ) {\n      if (!sanitize(e, this._targetOrigin)) return;\n      const msg = e.data as MessageData;\n      if (msg.type === type) {\n         callback();\n         this._PromiseResolver(this);\n      } else if (msg.type === \"event\" && msg.key != undefined) {\n         this._trigger(msg.key, msg.value);\n      }\n   }\n}\n\nclass Parent extends BaseChannel {\n   public container: HTMLElement;\n   public iframe: HTMLIFrameElement;\n   protected _handshakeInterval?: number;\n\n   constructor(opt: { container: string; url: string }) {\n      super();\n\n      const container = document.getElementById(opt.container);\n      if (!container) throw new Error(\"Container element not found\");\n      this.container = container;\n      this.iframe = document.createElement(\"iframe\");\n      this.iframe.style.width = \"100%\";\n      this.iframe.style.height = \"100%\";\n\n      this.container.appendChild(this.iframe);\n\n      this._targetOrigin = new URL(opt.url, window.location.href).origin;\n\n      this.iframe.addEventListener(\"load\", () => {\n         this._targetWindow = this.iframe.contentWindow;\n         this._startHandshake();\n      });\n      this.iframe.src = opt.url;\n   }\n\n   public ready(\n      callback: (\n         event: {\n            iframe: HTMLIFrameElement;\n            container: HTMLElement;\n         } & ReadyEvent\n      ) => void\n   ): void {\n      super.ready(callback as any);\n   }\n\n   private _startHandshake(): void {\n      let attempt = 0;\n      const handshakeInterval = window.setInterval(() => {\n         attempt++;\n         if (attempt > MAX_HANDSHAKE_REQUESTS) {\n            clearInterval(handshakeInterval);\n            this._PromiseRejecter(new Error(\"Handshake failed\"));\n         } else {\n            this._sendMessage({ type: \"handshake\" });\n         }\n      }, HANDSHAKE_REQUESTS_INTERVAL);\n      this._handshakeInterval = handshakeInterval;\n   }\n\n   protected _onMessage(e: MessageEvent): void {\n      this._handleOnMessage(e, \"handshake-reply\", () =>\n         clearInterval(this._handshakeInterval)\n      );\n   }\n}\n\nclass Child extends BaseChannel {\n   constructor() {\n      super({\n         targetWindow: window.parent,\n         targetOrigin: window.parent.location.origin,\n      });\n   }\n\n   protected _onMessage(e: MessageEvent): void {\n      this._handleOnMessage(e, \"handshake\", () =>\n         this._sendMessage({ type: \"handshake-reply\" })\n      );\n   }\n}\n\nexport const Handshake = {\n   Parent,\n   Child,\n};\n"],"names":["ALLOWED_MESSAGE_TYPES","sanitize","message","allowedOrigin","data","BaseChannel","opt","__publicField","key","value","callback","resolve","reject","msg","_a","cb","type","Parent","container","attempt","handshakeInterval","e","Child","Handshake"],"mappings":"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"}